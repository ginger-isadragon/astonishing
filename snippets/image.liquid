{% doc %}
  Renders a responsive image that might be wrapped in a link with focal point support.

  When `width`, `height` and `crop` are provided, the image will be rendered
  with a fixed aspect ratio. Supports focal point positioning for better image cropping.

  @param {image} image - The image to be rendered
  @param {string} [url] - An optional destination URL for the image
  @param {string} [class] - Optional class to be added to the image wrapper
  @param {number} [width] - The highest resolution width of the image to be rendered
  @param {number} [height] - The highest resolution height of the image to be rendered
  @param {string} [crop] - The crop position of the image
  @param {boolean} [lazy] - Enable lazy loading (default: true)
  @param {string} [sizes] - Responsive sizes attribute
  @param {string} [alt] - Alternative text (defaults to image.alt)

  @example
  {% render 'image', image: product.featured_image %}
  {% render 'image', image: product.featured_image, url: product.url %}
  {% render 'image',
    class: 'product__image',
    image: product.featured_image,
    url: product.url,
    width: 1200,
    height: 800,
    crop: 'center',
  %}
{% enddoc %}

{% liquid
  unless height
    assign width = width | default: image.width
  endunless

  if url
    assign wrapper = 'a'
  else
    assign wrapper = 'div'
  endif

  if lazy == false
    assign loading = 'eager'
  else
    assign loading = 'lazy'
  endif

  assign alt_text = alt | default: image.alt | escape
%}

<{{ wrapper }}
  class="image {{ class }}"
  {% if url %}
    href="{{ url }}"
  {% endif %}
>
  {% if image %}
    {% comment %} Support for focal point {% endcomment %}
    {% if image.presentation.focal_point %}
      <img
        src="{{ image | image_url: width: width, height: height, crop: crop }}"
        alt="{{ alt_text }}"
        loading="{{ loading }}"
        width="{{ width | default: image.width }}"
        height="{{ height | default: image.height }}"
        {% if sizes %}sizes="{{ sizes }}"{% endif %}
        style="object-position: {{ image.presentation.focal_point.x | times: 100 }}% {{ image.presentation.focal_point.y | times: 100 }}%;"
      >
    {% else %}
      {{ image | image_url: width: width, height: height, crop: crop | image_tag: loading: loading, alt: alt_text, sizes: sizes }}
    {% endif %}
  {% else %}
    {% comment %} Placeholder for missing images {% endcomment %}
    <div class="image-placeholder" style="padding-bottom: {% if height and width %}{{ height | times: 100.0 | divided_by: width }}%{% else %}100%{% endif %};">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
        <circle cx="8.5" cy="8.5" r="1.5"/>
        <polyline points="21 15 16 10 5 21"/>
      </svg>
    </div>
  {% endif %}
</{{ wrapper }}>

{% stylesheet %}
  .image {
    display: block;
    position: relative;
    overflow: hidden;
    width: 100%;
    height: auto;
  }

  .image > img {
    width: 100%;
    height: auto;
    object-fit: cover;
  }

  .image-placeholder {
    position: relative;
    background: #f5f5f5;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .image-placeholder svg {
    position: absolute;
    width: 40%;
    height: 40%;
    color: #ccc;
  }
{% endstylesheet %}
