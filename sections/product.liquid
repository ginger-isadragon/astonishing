{% comment %}
  This section is used in the product template to render product page with
  media, content, and add-to-cart form.

  https://shopify.dev/docs/storefronts/themes/architecture/templates/product
{% endcomment %}

<div class="product" data-product-id="{{ product.id }}">
  <div class="product-media">
    {% comment %} Product media gallery with rich media support {% endcomment %}
    <div class="product-media__gallery" id="product-media-gallery">
      {% for media in product.media %}
        <div
          class="product-media__item {% if forloop.first %}active{% endif %}"
          data-media-id="{{ media.id }}"
          {% if media.media_type == 'image' and media.variant_ids.size > 0 %}
            data-variant-ids="{{ media.variant_ids | join: ',' }}"
          {% endif %}
        >
          {% case media.media_type %}
            {% when 'image' %}
              {% render 'image', class: 'product-media__image', image: media %}

            {% when 'video' or 'external_video' %}
              <div class="product-media__video">
                {{ media | media_tag: image_size: '1024x', autoplay: false, loop: false, controls: true }}
              </div>

            {% when 'model' %}
              <div class="product-media__model">
                {{ media | media_tag: image_size: '1024x', toggleable: true }}
              </div>
          {% endcase %}
        </div>
      {% endfor %}
    </div>

    {% comment %} Thumbnail navigation {% endcomment %}
    {% if product.media.size > 1 %}
      <div class="product-media__thumbnails">
        {% for media in product.media %}
          <button
            type="button"
            class="product-media__thumbnail {% if forloop.first %}active{% endif %}"
            data-media-id="{{ media.id }}"
            aria-label="View {{ media.media_type }}"
          >
            {% if media.preview_image %}
              <img src="{{ media.preview_image | image_url: width: 100 }}" alt="{{ media.alt | escape }}" loading="lazy">
            {% endif %}
            {% if media.media_type != 'image' %}
              <span class="media-badge">{{ media.media_type }}</span>
            {% endif %}
          </button>
        {% endfor %}
      </div>
    {% endif %}
  </div>

  <div class="product-info">
    <h1 class="product-title">{{ product.title }}</h1>

    {% comment %} Price with compare-at price and unit price {% endcomment %}
    <div class="product-price" id="product-price">
      {% assign current_variant = product.selected_or_first_available_variant %}

      {% if current_variant.compare_at_price > current_variant.price %}
        <span class="price price--sale">{{ current_variant.price | money }}</span>
        <span class="price price--compare">{{ current_variant.compare_at_price | money }}</span>
        <span class="price-badge price-badge--sale">
          {% assign savings = current_variant.compare_at_price | minus: current_variant.price %}
          {% assign savings_percent = savings | times: 100.0 | divided_by: current_variant.compare_at_price | round %}
          Save {{ savings_percent }}%
        </span>
      {% else %}
        <span class="price">{{ current_variant.price | money }}</span>
      {% endif %}

      {% comment %} Unit pricing {% endcomment %}
      {% if current_variant.unit_price %}
        <div class="unit-price">
          <span class="unit-price__price">{{ current_variant.unit_price | money }}</span>
          <span class="unit-price__separator">/</span>
          <span class="unit-price__unit">
            {%- if current_variant.unit_price_measurement.reference_value != 1 -%}
              {{ current_variant.unit_price_measurement.reference_value }}
            {%- endif -%}
            {{ current_variant.unit_price_measurement.reference_unit }}
          </span>
        </div>
      {% endif %}
    </div>

    {% comment %} Shop Pay Installments {% endcomment %}
    {% if shop.enabled_payment_types contains 'shopify_installments' %}
      <div class="product-installments">
        {{ form | payment_terms }}
      </div>
    {% endif %}

    {% comment %} Product description {% endcomment %}
    {% if product.description != blank %}
      <div class="product-description">
        {{ product.description }}
      </div>
    {% endif %}

    {% comment %} Product form {% endcomment %}
    <div class="product-form">
      {% form 'product', product, id: 'product-form' %}
        {% comment %} Variant selector {% endcomment %}
        {% unless product.has_only_default_variant %}
          <div class="product-variants">
            {% for option in product.options_with_values %}
              <div class="product-option">
                <label for="option-{{ option.position }}">{{ option.name }}</label>
                <select
                  id="option-{{ option.position }}"
                  name="options[{{ option.name | escape }}]"
                  class="product-option__select"
                  data-option-position="{{ option.position }}"
                >
                  {% for value in option.values %}
                    <option
                      value="{{ value | escape }}"
                      {% if option.selected_value == value %}selected{% endif %}
                    >
                      {{ value }}
                    </option>
                  {% endfor %}
                </select>
              </div>
            {% endfor %}
          </div>
        {% endunless %}

        <input type="hidden" name="id" value="{{ current_variant.id }}" id="variant-id">

        {% comment %} Quantity selector {% endcomment %}
        <div class="product-quantity">
          <label for="quantity">Quantity</label>
          <input
            type="number"
            id="quantity"
            name="quantity"
            min="1"
            value="1"
            class="product-quantity__input"
          >
        </div>

        {% comment %} Local pickup availability {% endcomment %}
        {% if current_variant.available and current_variant.store_availabilities.size > 0 %}
          <div class="product-pickup">
            <p class="product-pickup__heading">Available for pickup</p>
            {% for availability in current_variant.store_availabilities limit: 3 %}
              <div class="product-pickup__location">
                <span class="pickup-icon">üìç</span>
                <div class="pickup-details">
                  <p class="pickup-location-name">{{ availability.location.name }}</p>
                  {% if availability.pick_up_time %}
                    <p class="pickup-time">Usually ready in {{ availability.pick_up_time }}</p>
                  {% endif %}
                </div>
              </div>
            {% endfor %}
          </div>
        {% endif %}

        {% comment %} Add to cart button {% endcomment %}
        <button
          type="submit"
          name="add"
          class="product-form__submit"
          {% unless current_variant.available %}disabled{% endunless %}
        >
          {% if current_variant.available %}
            Add to cart
          {% else %}
            Sold out
          {% endif %}
        </button>

        {% comment %} Accelerated checkout buttons {% endcomment %}
        {{ form | payment_button }}
      {% endform %}
    </div>
  </div>
</div>

{% comment %} Product recommendations {% endcomment %}
{% if section.settings.show_recommendations %}
  <div class="product-recommendations" data-product-id="{{ product.id }}">
    <h2>{{ section.settings.recommendations_heading }}</h2>
    <div class="product-recommendations__inner" id="product-recommendations">
      {% comment %} Recommendations loaded via AJAX {% endcomment %}
    </div>
  </div>
{% endif %}

{% stylesheet %}
  .product {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    max-width: var(--page-width);
    margin: 0 auto;
    padding: var(--page-margin);
  }

  .product-media__gallery {
    position: relative;
  }

  .product-media__item {
    display: none;
  }

  .product-media__item.active {
    display: block;
  }

  .product-media__image,
  .product-media__video,
  .product-media__model {
    width: 100%;
    height: auto;
  }

  .product-media__thumbnails {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
    overflow-x: auto;
  }

  .product-media__thumbnail {
    position: relative;
    width: 80px;
    height: 80px;
    border: 2px solid transparent;
    cursor: pointer;
    background: none;
    padding: 0;
  }

  .product-media__thumbnail.active {
    border-color: var(--color-foreground);
  }

  .product-media__thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .media-badge {
    position: absolute;
    bottom: 4px;
    right: 4px;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 2px 6px;
    font-size: 0.7rem;
    text-transform: uppercase;
  }

  .product-price {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin: 1rem 0;
  }

  .price {
    font-size: 1.5rem;
    font-weight: 700;
  }

  .price--sale {
    color: #c00;
  }

  .price--compare {
    text-decoration: line-through;
    font-size: 1.2rem;
    color: #999;
  }

  .price-badge--sale {
    background: #c00;
    color: white;
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
    border-radius: 4px;
  }

  .unit-price {
    font-size: 0.875rem;
    color: #666;
    width: 100%;
  }

  .product-installments {
    margin: 1rem 0;
  }

  .product-description {
    margin: 1.5rem 0;
    line-height: 1.6;
  }

  .product-variants {
    margin: 1rem 0;
  }

  .product-option {
    margin-bottom: 1rem;
  }

  .product-option label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
  }

  .product-option__select {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #ccc;
    border-radius: var(--style-border-radius-inputs);
  }

  .product-quantity {
    margin: 1rem 0;
  }

  .product-quantity label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
  }

  .product-quantity__input {
    width: 80px;
    padding: 0.5rem;
    border: 1px solid #ccc;
    border-radius: var(--style-border-radius-inputs);
  }

  .product-pickup {
    margin: 1rem 0;
    padding: 1rem;
    background: #f5f5f5;
    border-radius: 4px;
  }

  .product-pickup__heading {
    font-weight: 600;
    margin-bottom: 0.5rem;
  }

  .product-pickup__location {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.5rem;
  }

  .pickup-location-name {
    font-weight: 600;
  }

  .pickup-time {
    font-size: 0.875rem;
    color: #666;
  }

  .product-form__submit {
    width: 100%;
    padding: 1rem;
    background: var(--color-foreground);
    color: var(--color-background);
    border: none;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 1rem;
    border-radius: var(--style-border-radius-inputs);
  }

  .product-form__submit:disabled {
    background: #ccc;
    cursor: not-allowed;
  }

  .product-recommendations {
    max-width: var(--page-width);
    margin: 3rem auto;
    padding: var(--page-margin);
  }

  .product-recommendations h2 {
    margin-bottom: 1.5rem;
  }

  .product-recommendations__inner {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 1.5rem;
  }

  @media (max-width: 768px) {
    .product {
      grid-template-columns: 1fr;
    }
  }
{% endstylesheet %}

{% javascript %}
  class ProductPage {
    constructor() {
      this.form = document.getElementById('product-form');
      this.variantId = document.getElementById('variant-id');
      this.productData = null;

      this.init();
    }

    async init() {
      await this.loadProductData();
      this.setupVariantSelectors();
      this.setupMediaGallery();
      this.loadRecommendations();
    }

    async loadProductData() {
      const productId = document.querySelector('.product').dataset.productId;
      const response = await fetch(`/products/${window.location.pathname.split('/').pop()}.js`);
      this.productData = await response.json();
    }

    setupVariantSelectors() {
      const selectors = document.querySelectorAll('.product-option__select');
      selectors.forEach(select => {
        select.addEventListener('change', () => this.handleVariantChange());
      });
    }

    handleVariantChange() {
      const options = [];
      document.querySelectorAll('.product-option__select').forEach(select => {
        options.push(select.value);
      });

      const variant = this.productData.variants.find(v => {
        return options.every((option, index) => v.options[index] === option);
      });

      if (variant) {
        this.updateVariant(variant);
      }
    }

    updateVariant(variant) {
      // Update hidden variant ID
      this.variantId.value = variant.id;

      // Update price
      this.updatePrice(variant);

      // Update variant image
      this.updateVariantImage(variant);

      // Update button state
      const submitButton = document.querySelector('.product-form__submit');
      if (variant.available) {
        submitButton.disabled = false;
        submitButton.textContent = 'Add to cart';
      } else {
        submitButton.disabled = true;
        submitButton.textContent = 'Sold out';
      }

      // Update URL without reload
      const url = new URL(window.location);
      url.searchParams.set('variant', variant.id);
      window.history.replaceState({}, '', url);
    }

    updatePrice(variant) {
      const priceContainer = document.getElementById('product-price');
      let priceHTML = '';

      if (variant.compare_at_price && variant.compare_at_price > variant.price) {
        const savings = variant.compare_at_price - variant.price;
        const savingsPercent = Math.round((savings / variant.compare_at_price) * 100);

        priceHTML = `
          <span class="price price--sale">${this.formatMoney(variant.price)}</span>
          <span class="price price--compare">${this.formatMoney(variant.compare_at_price)}</span>
          <span class="price-badge price-badge--sale">Save ${savingsPercent}%</span>
        `;
      } else {
        priceHTML = `<span class="price">${this.formatMoney(variant.price)}</span>`;
      }

      // Add unit price if available
      if (variant.unit_price) {
        const unitPriceHTML = `
          <div class="unit-price">
            <span class="unit-price__price">${this.formatMoney(variant.unit_price)}</span>
            <span class="unit-price__separator">/</span>
            <span class="unit-price__unit">${variant.unit_price_measurement.reference_value > 1 ? variant.unit_price_measurement.reference_value : ''}${variant.unit_price_measurement.reference_unit}</span>
          </div>
        `;
        priceHTML += unitPriceHTML;
      }

      priceContainer.innerHTML = priceHTML;
    }

    updateVariantImage(variant) {
      if (!variant.featured_media) return;

      const mediaItems = document.querySelectorAll('.product-media__item');
      const thumbnails = document.querySelectorAll('.product-media__thumbnail');

      // Find and activate the media item for this variant
      mediaItems.forEach(item => {
        const variantIds = item.dataset.variantIds ? item.dataset.variantIds.split(',') : [];
        if (item.dataset.mediaId == variant.featured_media.id || variantIds.includes(String(variant.id))) {
          item.classList.add('active');
        } else {
          item.classList.remove('active');
        }
      });

      // Update thumbnail active state
      thumbnails.forEach(thumb => {
        if (thumb.dataset.mediaId == variant.featured_media.id) {
          thumb.classList.add('active');
        } else {
          thumb.classList.remove('active');
        }
      });
    }

    setupMediaGallery() {
      const thumbnails = document.querySelectorAll('.product-media__thumbnail');
      thumbnails.forEach(thumb => {
        thumb.addEventListener('click', (e) => {
          const mediaId = thumb.dataset.mediaId;
          this.activateMedia(mediaId);
        });
      });
    }

    activateMedia(mediaId) {
      document.querySelectorAll('.product-media__item').forEach(item => {
        if (item.dataset.mediaId === mediaId) {
          item.classList.add('active');
        } else {
          item.classList.remove('active');
        }
      });

      document.querySelectorAll('.product-media__thumbnail').forEach(thumb => {
        if (thumb.dataset.mediaId === mediaId) {
          thumb.classList.add('active');
        } else {
          thumb.classList.remove('active');
        }
      });
    }

    async loadRecommendations() {
      const container = document.getElementById('product-recommendations');
      if (!container) return;

      const productId = document.querySelector('.product').dataset.productId;
      const response = await fetch(`/recommendations/products.json?product_id=${productId}&limit=4`);
      const data = await response.json();

      if (data.products && data.products.length > 0) {
        container.innerHTML = data.products.map(product => `
          <div class="product-card">
            <a href="${product.url}">
              ${product.featured_image ? `<img src="${product.featured_image}" alt="${product.title}" loading="lazy">` : ''}
              <h3>${product.title}</h3>
              <p>${this.formatMoney(product.price)}</p>
            </a>
          </div>
        `).join('');
      }
    }

    formatMoney(cents) {
      return (cents / 100).toLocaleString('en-US', {
        style: 'currency',
        currency: window.Shopify?.currency?.active || 'USD'
      });
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => new ProductPage());
  } else {
    new ProductPage();
  }
{% endjavascript %}

{% schema %}
{
  "name": "t:general.product",
  "settings": [
    {
      "type": "checkbox",
      "id": "show_recommendations",
      "label": "Show product recommendations",
      "default": true
    },
    {
      "type": "text",
      "id": "recommendations_heading",
      "label": "Recommendations heading",
      "default": "You may also like"
    }
  ],
  "disabled_on": {
    "groups": ["header", "footer"]
  }
}
{% endschema %}
