{% comment %}
  This section is used in the search template to render search results for
  products, articles, and pages.

  https://shopify.dev/docs/storefronts/themes/architecture/templates/search
{% endcomment %}

<div class="search-page">
  <div class="search-header">
    <h1>{{ 'search.title' | t }}</h1>

    <form action="{{ routes.search_url }}" method="get" role="search" class="search-form" id="search-form">
      <div class="search-input-wrapper">
        <input
          type="search"
          name="q"
          id="search-input"
          value="{{ search.terms | escape }}"
          placeholder="{{ 'search.placeholder' | t }}"
          class="search-input"
          autocomplete="off"
          aria-label="Search"
        >
        <button type="submit" class="search-submit" aria-label="Submit search">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
            <path d="M9 17A8 8 0 1 0 9 1a8 8 0 0 0 0 16zM18 18l-4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>

        {% comment %} Predictive search results {% endcomment %}
        <div class="predictive-search" id="predictive-search" hidden>
          <div class="predictive-search__loading" id="predictive-loading" hidden>
            Searching...
          </div>
          <div class="predictive-search__results" id="predictive-results"></div>
        </div>
      </div>

      {% if section.settings.show_filters %}
        <div class="search-filters">
          <label class="search-filter-option">
            <input type="radio" name="type" value="" {% unless search.types.size > 0 %}checked{% endunless %}>
            All
          </label>
          <label class="search-filter-option">
            <input type="radio" name="type" value="product" {% if search.types contains 'product' %}checked{% endif %}>
            Products
          </label>
          <label class="search-filter-option">
            <input type="radio" name="type" value="article" {% if search.types contains 'article' %}checked{% endif %}>
            Articles
          </label>
          <label class="search-filter-option">
            <input type="radio" name="type" value="page" {% if search.types contains 'page' %}checked{% endif %}>
            Pages
          </label>
        </div>
      {% endif %}
    </form>
  </div>

  {% if search.performed %}
    {% if search.results_count == 0 %}
      <div class="search-no-results">
        <h2>No results found for "{{ search.terms }}"</h2>
        <p>Try different keywords or browse our collections</p>
        <a href="{{ routes.all_products_collection_url }}" class="button">Browse all products</a>
      </div>
    {% else %}
      <div class="search-results-header">
        <p>{{ search.results_count }} result{% if search.results_count > 1 %}s{% endif %} for "{{ search.terms }}"</p>
      </div>

      <div class="search-results">
        {% paginate search.results by section.settings.results_per_page %}
          {% assign product_results = search.results | where: "object_type", "product" %}
          {% assign article_results = search.results | where: "object_type", "article" %}
          {% assign page_results = search.results | where: "object_type", "page" %}

          {% comment %} Product results {% endcomment %}
          {% if product_results.size > 0 %}
            <div class="search-results-section">
              <h2 class="search-results-section__title">Products</h2>
              <div class="search-results-grid">
                {% for product in product_results %}
                  <div class="search-result search-result--product">
                    <a href="{{ product.url }}" class="search-result__link">
                      {% if product.featured_media %}
                        <div class="search-result__image">
                          {% render 'image', image: product.featured_media, width: 300, height: 300 %}
                        </div>
                      {% endif %}
                      <div class="search-result__content">
                        <h3 class="search-result__title">{{ product.title }}</h3>
                        {% if product.vendor and section.settings.show_vendor %}
                          <p class="search-result__vendor">{{ product.vendor }}</p>
                        {% endif %}
                        <div class="search-result__price">
                          {% if product.compare_at_price > product.price %}
                            <span class="price price--sale">{{ product.price | money }}</span>
                            <span class="price price--compare">{{ product.compare_at_price | money }}</span>
                          {% else %}
                            <span class="price">{{ product.price | money }}</span>
                          {% endif %}
                        </div>
                      </div>
                    </a>
                  </div>
                {% endfor %}
              </div>
            </div>
          {% endif %}

          {% comment %} Article results {% endcomment %}
          {% if article_results.size > 0 %}
            <div class="search-results-section">
              <h2 class="search-results-section__title">Articles</h2>
              <div class="search-results-list">
                {% for article in article_results %}
                  <div class="search-result search-result--article">
                    <a href="{{ article.url }}" class="search-result__link">
                      {% if article.image %}
                        <div class="search-result__image">
                          {% render 'image', image: article.image, width: 200, height: 200 %}
                        </div>
                      {% endif %}
                      <div class="search-result__content">
                        <h3 class="search-result__title">{{ article.title }}</h3>
                        {% if article.excerpt != blank %}
                          <p class="search-result__excerpt">{{ article.excerpt | strip_html | truncate: 150 }}</p>
                        {% endif %}
                        <p class="search-result__date">{{ article.published_at | date: "%B %d, %Y" }}</p>
                      </div>
                    </a>
                  </div>
                {% endfor %}
              </div>
            </div>
          {% endif %}

          {% comment %} Page results {% endcomment %}
          {% if page_results.size > 0 %}
            <div class="search-results-section">
              <h2 class="search-results-section__title">Pages</h2>
              <div class="search-results-list">
                {% for page in page_results %}
                  <div class="search-result search-result--page">
                    <a href="{{ page.url }}" class="search-result__link">
                      <div class="search-result__content">
                        <h3 class="search-result__title">{{ page.title }}</h3>
                        {% if page.content != blank %}
                          <p class="search-result__excerpt">{{ page.content | strip_html | truncate: 150 }}</p>
                        {% endif %}
                      </div>
                    </a>
                  </div>
                {% endfor %}
              </div>
            </div>
          {% endif %}

          {% if paginate.pages > 1 %}
            <div class="search-pagination">
              {{ paginate | default_pagination }}
            </div>
          {% endif %}
        {% endpaginate %}
      </div>
    {% endif %}
  {% endif %}
</div>

{% stylesheet %}
  .search-page {
    max-width: var(--page-width);
    margin: 0 auto;
    padding: var(--page-margin);
  }

  .search-header {
    margin-bottom: 2rem;
  }

  .search-form {
    max-width: 600px;
    margin: 2rem 0;
  }

  .search-input-wrapper {
    position: relative;
  }

  .search-input {
    width: 100%;
    padding: 1rem 3rem 1rem 1rem;
    border: 2px solid #ccc;
    border-radius: var(--style-border-radius-inputs);
    font-size: 1rem;
  }

  .search-input:focus {
    outline: none;
    border-color: var(--color-foreground);
  }

  .search-submit {
    position: absolute;
    right: 1rem;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    cursor: pointer;
    padding: 0.5rem;
    color: var(--color-foreground);
  }

  .predictive-search {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    margin-top: 0.5rem;
    background: white;
    border: 1px solid #ccc;
    border-radius: var(--style-border-radius-inputs);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    z-index: 100;
    max-height: 500px;
    overflow-y: auto;
  }

  .predictive-search__loading {
    padding: 1rem;
    text-align: center;
    color: #666;
  }

  .predictive-search__results {
    padding: 1rem;
  }

  .predictive-search-section {
    margin-bottom: 1.5rem;
  }

  .predictive-search-section__title {
    font-size: 0.875rem;
    font-weight: 600;
    text-transform: uppercase;
    color: #666;
    margin-bottom: 0.75rem;
  }

  .predictive-search-item {
    display: flex;
    gap: 1rem;
    padding: 0.75rem;
    border-radius: 4px;
    text-decoration: none;
    color: var(--color-foreground);
    transition: background 0.2s;
  }

  .predictive-search-item:hover {
    background: #f5f5f5;
  }

  .predictive-search-item__image {
    width: 60px;
    height: 60px;
    flex-shrink: 0;
  }

  .predictive-search-item__image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 4px;
  }

  .predictive-search-item__content {
    flex: 1;
  }

  .predictive-search-item__title {
    font-weight: 600;
    margin-bottom: 0.25rem;
  }

  .predictive-search-item__price {
    font-size: 0.875rem;
    color: #666;
  }

  .search-filters {
    display: flex;
    gap: 1rem;
    margin-top: 1rem;
    flex-wrap: wrap;
  }

  .search-filter-option {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
  }

  .search-no-results {
    text-align: center;
    padding: 3rem 0;
  }

  .search-no-results h2 {
    margin-bottom: 1rem;
  }

  .search-no-results p {
    margin-bottom: 1.5rem;
    color: #666;
  }

  .search-results-header {
    margin-bottom: 1.5rem;
    padding: 1rem;
    background: #f5f5f5;
    border-radius: 4px;
  }

  .search-results-section {
    margin-bottom: 3rem;
  }

  .search-results-section__title {
    margin-bottom: 1.5rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #ccc;
  }

  .search-results-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 1.5rem;
  }

  .search-results-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .search-result--product {
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    overflow: hidden;
  }

  .search-result--article,
  .search-result--page {
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    padding: 1rem;
  }

  .search-result__link {
    text-decoration: none;
    color: var(--color-foreground);
    display: block;
  }

  .search-result--article .search-result__link,
  .search-result--page .search-result__link {
    display: flex;
    gap: 1rem;
  }

  .search-result__image {
    position: relative;
    overflow: hidden;
  }

  .search-result--product .search-result__image {
    aspect-ratio: 1;
  }

  .search-result--article .search-result__image {
    width: 150px;
    height: 150px;
    flex-shrink: 0;
  }

  .search-result__image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .search-result__content {
    padding: 1rem;
  }

  .search-result--article .search-result__content,
  .search-result--page .search-result__content {
    flex: 1;
    padding: 0;
  }

  .search-result__title {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
  }

  .search-result__vendor {
    font-size: 0.875rem;
    color: #666;
    margin-bottom: 0.5rem;
  }

  .search-result__price {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .search-result__excerpt {
    font-size: 0.875rem;
    color: #666;
    margin-bottom: 0.5rem;
    line-height: 1.5;
  }

  .search-result__date {
    font-size: 0.75rem;
    color: #999;
  }

  .search-pagination {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    margin-top: 2rem;
  }

  @media (max-width: 768px) {
    .search-results-grid {
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    }

    .search-result--article .search-result__link {
      flex-direction: column;
    }

    .search-result--article .search-result__image {
      width: 100%;
      height: 200px;
    }
  }
{% endstylesheet %}

{% javascript %}
  class PredictiveSearch {
    constructor() {
      this.input = document.getElementById('search-input');
      this.results = document.getElementById('predictive-results');
      this.loading = document.getElementById('predictive-loading');
      this.container = document.getElementById('predictive-search');
      this.searchTimeout = null;
      this.minChars = 2;

      if (!this.input) return;

      this.init();
    }

    init() {
      this.input.addEventListener('input', (e) => {
        this.handleInput(e.target.value);
      });

      this.input.addEventListener('focus', () => {
        if (this.input.value.length >= this.minChars) {
          this.container.removeAttribute('hidden');
        }
      });

      // Close on click outside
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.search-input-wrapper')) {
          this.container.setAttribute('hidden', '');
        }
      });

      // Handle keyboard navigation
      this.input.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          this.container.setAttribute('hidden', '');
        }
      });
    }

    handleInput(value) {
      clearTimeout(this.searchTimeout);

      if (value.length < this.minChars) {
        this.container.setAttribute('hidden', '');
        return;
      }

      this.loading.removeAttribute('hidden');
      this.results.innerHTML = '';
      this.container.removeAttribute('hidden');

      this.searchTimeout = setTimeout(() => {
        this.performSearch(value);
      }, 300);
    }

    async performSearch(query) {
      try {
        const response = await fetch(
          `/search/suggest.json?q=${encodeURIComponent(query)}&resources[type]=product,article,page&resources[limit]=6`
        );

        const data = await response.json();
        this.loading.setAttribute('hidden', '');
        this.displayResults(data.resources.results);
      } catch (error) {
        console.error('Search error:', error);
        this.loading.setAttribute('hidden', '');
        this.results.innerHTML = '<p style="padding: 1rem;">An error occurred. Please try again.</p>';
      }
    }

    displayResults(results) {
      if (!results.products && !results.articles && !results.pages) {
        this.results.innerHTML = '<p style="padding: 1rem; color: #666;">No results found</p>';
        return;
      }

      let html = '';

      // Products
      if (results.products && results.products.length > 0) {
        html += '<div class="predictive-search-section">';
        html += '<h3 class="predictive-search-section__title">Products</h3>';
        results.products.forEach(product => {
          html += `
            <a href="${product.url}" class="predictive-search-item">
              ${product.image ? `
                <div class="predictive-search-item__image">
                  <img src="${product.image}" alt="${product.title}" loading="lazy">
                </div>
              ` : ''}
              <div class="predictive-search-item__content">
                <div class="predictive-search-item__title">${product.title}</div>
                <div class="predictive-search-item__price">${this.formatMoney(product.price)}</div>
              </div>
            </a>
          `;
        });
        html += '</div>';
      }

      // Articles
      if (results.articles && results.articles.length > 0) {
        html += '<div class="predictive-search-section">';
        html += '<h3 class="predictive-search-section__title">Articles</h3>';
        results.articles.forEach(article => {
          html += `
            <a href="${article.url}" class="predictive-search-item">
              ${article.image ? `
                <div class="predictive-search-item__image">
                  <img src="${article.image}" alt="${article.title}" loading="lazy">
                </div>
              ` : ''}
              <div class="predictive-search-item__content">
                <div class="predictive-search-item__title">${article.title}</div>
              </div>
            </a>
          `;
        });
        html += '</div>';
      }

      // Pages
      if (results.pages && results.pages.length > 0) {
        html += '<div class="predictive-search-section">';
        html += '<h3 class="predictive-search-section__title">Pages</h3>';
        results.pages.forEach(page => {
          html += `
            <a href="${page.url}" class="predictive-search-item">
              <div class="predictive-search-item__content">
                <div class="predictive-search-item__title">${page.title}</div>
              </div>
            </a>
          `;
        });
        html += '</div>';
      }

      this.results.innerHTML = html;
    }

    formatMoney(cents) {
      return (cents / 100).toLocaleString('en-US', {
        style: 'currency',
        currency: window.Shopify?.currency?.active || 'USD'
      });
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => new PredictiveSearch());
  } else {
    new PredictiveSearch();
  }
{% endjavascript %}

{% schema %}
{
  "name": "t:general.search",
  "settings": [
    {
      "type": "range",
      "id": "results_per_page",
      "min": 12,
      "max": 48,
      "step": 12,
      "label": "Results per page",
      "default": 24
    },
    {
      "type": "checkbox",
      "id": "show_vendor",
      "label": "Show vendor",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "show_filters",
      "label": "Show result type filters",
      "default": true
    }
  ]
}
{% endschema %}
